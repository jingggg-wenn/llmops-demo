name: Deploy Model to OpenShift

on:
  push:
    branches:
      - main
    paths:
      - 'deploy_model/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  deploy:
    name: Deploy to OpenShift
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for accurate diff detection
      
      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          sudo chmod +x /usr/local/bin/oc
          oc version --client
      
      - name: Login to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true
          oc whoami
          echo "Logged in to OpenShift successfully"
      
      - name: Determine environment
        id: determine_env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            echo "Manual workflow dispatch, deploying to: $ENV"
          else
            # Auto-detect based on changed files
            echo "Detecting environment from changed files..."
            echo "Push event from: ${{ github.event.before }} to ${{ github.event.after }}"
            
            # Use GitHub's event data for merge-friendly detection
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              # Use the before/after SHAs from GitHub event
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }})
            else
              # Fallback for first commit or when event data unavailable
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git show --name-only --pretty=format: HEAD)
            fi
            
            echo ""
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo ""
            
            # Check which overlay was changed (priority: prod > staging > dev)
            if echo "$CHANGED_FILES" | grep -q 'deploy_model/overlays/production/'; then
              ENV="production"
              echo "✓ Detected PRODUCTION overlay changes"
            elif echo "$CHANGED_FILES" | grep -q 'deploy_model/overlays/staging/'; then
              ENV="staging"
              echo "✓ Detected STAGING overlay changes"
            elif echo "$CHANGED_FILES" | grep -q 'deploy_model/overlays/dev/'; then
              ENV="dev"
              echo "✓ Detected DEV overlay changes"
            elif echo "$CHANGED_FILES" | grep -q 'deploy_model/base/'; then
              ENV="dev"
              echo "✓ Detected base/ changes, defaulting to DEV for testing"
            else
              ENV="dev"
              echo "⚠ No overlay detected in changes, defaulting to DEV"
            fi
          fi
          
          # Set namespace based on environment
          case $ENV in
            production)
              NAMESPACE="llmops-prod"
              PREFIX="prod-"
              ;;
            staging)
              NAMESPACE="llmops-staging"
              PREFIX="staging-"
              ;;
            dev)
              NAMESPACE="llmops-dev"
              PREFIX="dev-"
              ;;
          esac
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
          echo "==> Deploying to: $ENV (namespace: $NAMESPACE)"
      
      - name: Show what changed
        run: |
          echo "Deployment triggered by: ${{ github.actor }}"
          echo "Target environment: ${{ steps.determine_env.outputs.environment }}"
          echo "Target namespace: ${{ steps.determine_env.outputs.namespace }}"
          echo "Commit message: ${{ github.event.head_commit.message }}"
          echo "Files changed:"
          git diff --name-only HEAD^ HEAD | grep 'deploy_model/' || echo "No deploy_model files changed"
      
      - name: Deploy model to OpenShift
        run: |
          ENV="${{ steps.determine_env.outputs.environment }}"
          NAMESPACE="${{ steps.determine_env.outputs.namespace }}"
          echo "Deploying $ENV environment to namespace: $NAMESPACE"
          oc apply -k deploy_model/overlays/$ENV/
          echo "Deployment applied successfully for $ENV environment in $NAMESPACE namespace"
      
      - name: Wait for InferenceService to be ready
        run: |
          ENV="${{ steps.determine_env.outputs.environment }}"
          NAMESPACE="${{ steps.determine_env.outputs.namespace }}"
          PREFIX="${{ steps.determine_env.outputs.prefix }}"
          
          echo "Waiting for InferenceService ${PREFIX}qwen25-05b-instruct to be ready in $NAMESPACE..."
          oc wait --for=condition=Ready inferenceservice/${PREFIX}qwen25-05b-instruct -n $NAMESPACE --timeout=600s || true
          oc get inferenceservice -n $NAMESPACE
          echo "Current deployment status for $ENV environment:"
          oc describe inferenceservice ${PREFIX}qwen25-05b-instruct -n $NAMESPACE | tail -20
      
      - name: Show deployment info
        if: always()
        run: |
          NAMESPACE="${{ steps.determine_env.outputs.namespace }}"
          echo "=== InferenceService Status in $NAMESPACE ==="
          oc get inferenceservice -n $NAMESPACE -o wide
          echo ""
          echo "=== Pods ==="
          oc get pods -n $NAMESPACE
          echo ""
          echo "=== Recent Events ==="
          oc get events -n $NAMESPACE --sort-by='.lastTimestamp' | tail -10



